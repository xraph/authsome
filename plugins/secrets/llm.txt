# Secrets Plugin - LLM Reference

## Overview
The Secrets Plugin provides encrypted secrets management for AuthSome with hierarchical paths, versioning, and Forge ConfigSource integration.

## File Structure
```
plugins/secrets/
├── plugin.go              # Plugin lifecycle (Init, RegisterRoutes, Migrate)
├── config.go              # Configuration structs and defaults
├── service.go             # Business logic (CRUD, versioning, tree)
├── handlers.go            # HTTP handlers for REST API
├── repository.go          # Database operations (Bun ORM)
├── encryption.go          # AES-256-GCM encryption service
├── validation.go          # JSON/YAML validation and schema
├── configsource.go        # Forge ConfigSource implementation
├── dashboard_extension.go # Dashboard UI integration
├── core/
│   ├── types.go           # DTOs and request/response types
│   ├── errors.go          # Error definitions
│   └── path.go            # Path parsing utilities
├── schema/
│   └── secrets.go         # Database models
└── pages/
    ├── list.go            # Secrets list page
    ├── detail.go          # Secret detail page
    ├── form.go            # Create/edit forms
    └── history.go         # Version history page
```

## Key Types

### Database Models (schema/secrets.go)
- `Secret`: Main secrets table with encrypted value, path, tags, metadata
- `SecretVersion`: Version history for rollback
- `SecretAccessLog`: Audit trail for access tracking

### DTOs (core/types.go)
- `SecretDTO`: API response (no value)
- `SecretWithValueDTO`: Includes decrypted value
- `CreateSecretRequest`, `UpdateSecretRequest`: Input DTOs
- `ListSecretsQuery`: Query parameters for listing

### Value Types
- `plain`: Simple string
- `json`: JSON object/array
- `yaml`: YAML document
- `binary`: Base64-encoded binary

## Services

### EncryptionService (encryption.go)
- `NewEncryptionService(masterKeyBase64)`: Create with base64 master key
- `Encrypt(plaintext, appID, envID)`: Returns ciphertext + nonce
- `Decrypt(ciphertext, nonce, appID, envID)`: Returns plaintext
- `DeriveKey(appID, envID)`: Argon2 key derivation per tenant
- Uses AES-256-GCM with unique nonce per operation

### SchemaValidator (validation.go)
- `ValidateValue(value, valueType, schemaJSON)`: Validate against type/schema
- `ParseValue(raw, valueType)`: Parse string to typed value
- `SerializeValue(value, valueType)`: Serialize for storage
- `DetectValueType(value)`: Auto-detect value type

### Service (service.go)
- `Create(ctx, req)`: Create new secret
- `Get(ctx, id)`: Get metadata
- `GetValue(ctx, id)`: Get decrypted value
- `Update(ctx, id, req)`: Update (creates new version)
- `Delete(ctx, id)`: Soft delete
- `List(ctx, query)`: List with filtering
- `Rollback(ctx, id, version, reason)`: Restore old version
- `GetVersions(ctx, id, page, pageSize)`: Version history
- `GetTree(ctx, prefix)`: Tree structure for UI

## REST API

### Endpoints
```
GET    /secrets               List secrets
POST   /secrets               Create secret
GET    /secrets/:id           Get metadata
GET    /secrets/:id/value     Get decrypted value
PUT    /secrets/:id           Update secret
DELETE /secrets/:id           Delete secret
GET    /secrets/:id/versions  Version history
POST   /secrets/:id/rollback/:version  Rollback
GET    /secrets/path/*path    Get by path
GET    /secrets/stats         Statistics
GET    /secrets/tree          Tree structure
```

## Forge ConfigSource

When `configSource.enabled = true`:
- Secrets available via config manager
- Path `database/postgres/password` → key `database.postgres.password`
- Auto-refresh on secret changes
- Caches decrypted values in memory

## Plugin Integration

```go
// Create plugin
secretsPlugin := secrets.NewPlugin(
    secrets.WithConfigSourceEnabled(true),
    secrets.WithMasterKey(os.Getenv("MASTER_KEY")),
    secrets.WithMaxVersions(100),
)

// Register with AuthSome
auth := authsome.New(authsome.WithPlugins(secretsPlugin))

// Access service directly
svc := secretsPlugin.Service()
secret, err := svc.Create(ctx, &core.CreateSecretRequest{...})
```

## Path Format
- Hierarchical: `database/postgres/password`
- Lowercase, alphanumeric with underscores/hyphens
- No leading/trailing slashes
- Auto-normalized on input
- Example: `api-keys/stripe_live` → `api-keys/stripe_live`

## Security Model
1. Master key from environment variable
2. Per-tenant key derivation (Argon2id)
3. AES-256-GCM encryption per secret
4. Unique nonce per encryption
5. Soft delete preserves audit trail
6. RBAC integration for access control

## Dashboard Routes
```
/secrets               List page
/secrets/create        Create form
/secrets/:id           Detail page
/secrets/:id/edit      Edit form
/secrets/:id/history   Version history
```

## Common Operations

### Create Secret
```go
req := &core.CreateSecretRequest{
    Path:        "database/postgres/password",
    Value:       "secretpassword",
    ValueType:   "plain",
    Description: "Production database password",
    Tags:        []string{"production", "database"},
}
secret, err := svc.Create(ctx, req)
```

### Update Secret
```go
req := &core.UpdateSecretRequest{
    Value:        "newpassword",
    ChangeReason: "Quarterly rotation",
}
secret, err := svc.Update(ctx, secretID, req)
```

### Retrieve Value
```go
value, err := svc.GetValue(ctx, secretID)
// value is interface{} - string for plain, map for JSON, etc.
```

### List with Filters
```go
query := &core.ListSecretsQuery{
    Prefix:   "database",
    Tags:     []string{"production"},
    Page:     1,
    PageSize: 20,
}
secrets, pagination, err := svc.List(ctx, query)
```

### Rollback
```go
secret, err := svc.Rollback(ctx, secretID, 3, "Reverting bad change")
```

## Error Handling
All errors use the internal `errs` package:
- `ErrSecretNotFound(id)`: 404
- `ErrSecretExists(path)`: 409
- `ErrInvalidPath(path, reason)`: 400
- `ErrValidationFailed(reason, cause)`: 400
- `ErrDecryptionFailed(cause)`: 500
- `ErrMasterKeyRequired()`: 500
- `ErrSecretExpired(path)`: 410

## Testing
Run tests:
```bash
go test ./plugins/secrets/...
```

Key test files:
- `encryption_test.go`: Encryption round-trip, key derivation
- `validation_test.go`: Schema validation, parsing
- `core/path_test.go`: Path utilities

