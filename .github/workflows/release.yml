name: Release

on:
  push:
    tags:
      - 'v*.*.*'
      - 'clients/go/v*'
      - 'clients/typescript/v*'
      - 'clients/rust/v*'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'What to release'
        required: true
        type: choice
        options:
          - main
          - go-client
          - typescript-client
          - rust-client
          - all-clients
          - all
      version:
        description: 'Version to release (e.g. 1.2.3, without v prefix)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false
      dry_run:
        description: 'Dry run (validate only, do not publish)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  packages: write
  id-token: write

# Prevent concurrent releases
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ──────────────────────────────────────────────
  # Determine what to release
  # ──────────────────────────────────────────────
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      release_main: ${{ steps.determine.outputs.release_main }}
      release_go_client: ${{ steps.determine.outputs.release_go_client }}
      release_ts_client: ${{ steps.determine.outputs.release_ts_client }}
      release_rust_client: ${{ steps.determine.outputs.release_rust_client }}
      version: ${{ steps.determine.outputs.version }}
      prerelease: ${{ steps.determine.outputs.prerelease }}
      dry_run: ${{ steps.determine.outputs.dry_run }}
    steps:
      - name: Determine release targets
        id: determine
        run: |
          # Defaults
          RELEASE_MAIN=false
          RELEASE_GO=false
          RELEASE_TS=false
          RELEASE_RUST=false
          VERSION=""
          PRERELEASE=false
          DRY_RUN=false

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger
            VERSION="${{ inputs.version }}"
            PRERELEASE="${{ inputs.prerelease }}"
            DRY_RUN="${{ inputs.dry_run }}"

            case "${{ inputs.release_type }}" in
              main)
                RELEASE_MAIN=true
                ;;
              go-client)
                RELEASE_GO=true
                ;;
              typescript-client)
                RELEASE_TS=true
                ;;
              rust-client)
                RELEASE_RUST=true
                ;;
              all-clients)
                RELEASE_GO=true
                RELEASE_TS=true
                RELEASE_RUST=true
                ;;
              all)
                RELEASE_MAIN=true
                RELEASE_GO=true
                RELEASE_TS=true
                RELEASE_RUST=true
                ;;
            esac
          else
            # Tag-based trigger
            TAG="${GITHUB_REF#refs/tags/}"

            if [[ "$TAG" == clients/go/v* ]]; then
              RELEASE_GO=true
              VERSION="${TAG#clients/go/v}"
            elif [[ "$TAG" == clients/typescript/v* ]]; then
              RELEASE_TS=true
              VERSION="${TAG#clients/typescript/v}"
            elif [[ "$TAG" == clients/rust/v* ]]; then
              RELEASE_RUST=true
              VERSION="${TAG#clients/rust/v}"
            elif [[ "$TAG" == v* ]]; then
              RELEASE_MAIN=true
              VERSION="${TAG#v}"
            fi

            # Detect pre-release from tag (e.g., v1.0.0-rc.1)
            if [[ "$VERSION" == *"-"* ]]; then
              PRERELEASE=true
            fi
          fi

          echo "release_main=$RELEASE_MAIN" >> $GITHUB_OUTPUT
          echo "release_go_client=$RELEASE_GO" >> $GITHUB_OUTPUT
          echo "release_ts_client=$RELEASE_TS" >> $GITHUB_OUTPUT
          echo "release_rust_client=$RELEASE_RUST" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT
          echo "dry_run=$DRY_RUN" >> $GITHUB_OUTPUT

          echo "### Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Target | Release |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Main library | $RELEASE_MAIN |" >> $GITHUB_STEP_SUMMARY
          echo "| Go client | $RELEASE_GO |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript client | $RELEASE_TS |" >> $GITHUB_STEP_SUMMARY
          echo "| Rust client | $RELEASE_RUST |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | $VERSION |" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-release | $PRERELEASE |" >> $GITHUB_STEP_SUMMARY
          echo "| Dry run | $DRY_RUN |" >> $GITHUB_STEP_SUMMARY

  # ──────────────────────────────────────────────
  # Validate before releasing
  # ──────────────────────────────────────────────
  validate:
    name: Validate
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'
          cache: true

      - name: Validate version format
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          if [ -z "$VERSION" ]; then
            echo "::error::Version is empty"
            exit 1
          fi
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$'; then
            echo "::error::Invalid version format: $VERSION (expected semver like 1.2.3 or 1.2.3-rc.1)"
            exit 1
          fi
          echo "Version $VERSION is valid"

      - name: Run tests
        run: go test -race ./...

      - name: Verify module
        run: |
          go mod verify
          go mod tidy
          if [ -n "$(git status --porcelain go.mod go.sum)" ]; then
            echo "::error::go.mod or go.sum is not tidy"
            exit 1
          fi

  # ──────────────────────────────────────────────
  # Main library release (GoReleaser)
  # ──────────────────────────────────────────────
  release-main:
    name: Release Main Library
    runs-on: ubuntu-latest
    needs: [prepare, validate]
    if: needs.prepare.outputs.release_main == 'true' && needs.prepare.outputs.dry_run != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch all tags
        run: git fetch --force --tags

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'
          cache: true

      - name: Create and push tag (manual release)
        if: github.event_name == 'workflow_dispatch'
        run: |
          VERSION="v${{ needs.prepare.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$VERSION" -m "Release $VERSION"
          git push origin "$VERSION"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-binaries
          path: dist/*

  # ──────────────────────────────────────────────
  # Semantic release (for automatic version bumping)
  # ──────────────────────────────────────────────
  semantic-release:
    name: Semantic Release
    runs-on: ubuntu-latest
    needs: [prepare, validate]
    if: |
      needs.prepare.outputs.release_main == 'true'
      && github.event_name == 'push'
      && startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install semantic-release
        run: |
          npm install -g \
            semantic-release@23 \
            @semantic-release/changelog@6 \
            @semantic-release/git@10 \
            @semantic-release/github@10 \
            @semantic-release/exec@6 \
            conventional-changelog-conventionalcommits@7

      - name: Run semantic release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: npx semantic-release
        continue-on-error: true

  # ──────────────────────────────────────────────
  # Client releases (using reusable workflow)
  # ──────────────────────────────────────────────
  release-go-client:
    name: Release Go Client
    needs: [prepare, validate]
    if: needs.prepare.outputs.release_go_client == 'true' && needs.prepare.outputs.dry_run != 'true'
    uses: ./.github/workflows/reusable/release-client.yml
    with:
      client: go
      version: ${{ needs.prepare.outputs.version }}
      prerelease: ${{ needs.prepare.outputs.prerelease == 'true' }}
    secrets: inherit

  release-typescript-client:
    name: Release TypeScript Client
    needs: [prepare, validate]
    if: needs.prepare.outputs.release_ts_client == 'true' && needs.prepare.outputs.dry_run != 'true'
    uses: ./.github/workflows/reusable/release-client.yml
    with:
      client: typescript
      version: ${{ needs.prepare.outputs.version }}
      prerelease: ${{ needs.prepare.outputs.prerelease == 'true' }}
    secrets: inherit

  release-rust-client:
    name: Release Rust Client
    needs: [prepare, validate]
    if: needs.prepare.outputs.release_rust_client == 'true' && needs.prepare.outputs.dry_run != 'true'
    uses: ./.github/workflows/reusable/release-client.yml
    with:
      client: rust
      version: ${{ needs.prepare.outputs.version }}
      prerelease: ${{ needs.prepare.outputs.prerelease == 'true' }}
    secrets: inherit

  # ──────────────────────────────────────────────
  # Dry run summary
  # ──────────────────────────────────────────────
  dry-run-summary:
    name: Dry Run Summary
    runs-on: ubuntu-latest
    needs: [prepare, validate]
    if: needs.prepare.outputs.dry_run == 'true'
    steps:
      - name: Dry run complete
        run: |
          echo "### Dry Run Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Validation passed. The following would be released:" >> $GITHUB_STEP_SUMMARY
          echo "- Version: **${{ needs.prepare.outputs.version }}**" >> $GITHUB_STEP_SUMMARY
          echo "- Main: ${{ needs.prepare.outputs.release_main }}" >> $GITHUB_STEP_SUMMARY
          echo "- Go client: ${{ needs.prepare.outputs.release_go_client }}" >> $GITHUB_STEP_SUMMARY
          echo "- TypeScript client: ${{ needs.prepare.outputs.release_ts_client }}" >> $GITHUB_STEP_SUMMARY
          echo "- Rust client: ${{ needs.prepare.outputs.release_rust_client }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To perform the actual release, run again with **Dry run** unchecked." >> $GITHUB_STEP_SUMMARY

  # ──────────────────────────────────────────────
  # Release summary
  # ──────────────────────────────────────────────
  summary:
    name: Release Summary
    runs-on: ubuntu-latest
    if: always() && needs.prepare.outputs.dry_run != 'true'
    needs: [prepare, validate, release-main, release-go-client, release-typescript-client, release-rust-client]
    steps:
      - name: Generate summary
        run: |
          echo "### Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.prepare.outputs.release_main }}" = "true" ]; then
            echo "| Main Library | ${{ needs.release-main.result }} |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.prepare.outputs.release_go_client }}" = "true" ]; then
            echo "| Go Client | ${{ needs.release-go-client.result }} |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.prepare.outputs.release_ts_client }}" = "true" ]; then
            echo "| TypeScript Client | ${{ needs.release-typescript-client.result }} |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.prepare.outputs.release_rust_client }}" = "true" ]; then
            echo "| Rust Client | ${{ needs.release-rust-client.result }} |" >> $GITHUB_STEP_SUMMARY
          fi
