name: Release Rust Client

on:
  push:
    tags:
      - 'clients/rust/v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g. 1.2.3, without v prefix)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  extract-version:
    name: Extract Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      prerelease: ${{ steps.version.outputs.prerelease }}
    steps:
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
            echo "prerelease=${{ inputs.prerelease }}" >> $GITHUB_OUTPUT
          else
            VERSION="${GITHUB_REF#refs/tags/clients/rust/v}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            if [[ "$VERSION" == *"-"* ]]; then
              echo "prerelease=true" >> $GITHUB_OUTPUT
            else
              echo "prerelease=false" >> $GITHUB_OUTPUT
            fi
          fi

  release:
    name: Release
    needs: extract-version
    uses: ./.github/workflows/reusable/release-client.yml
    with:
      client: rust
      version: ${{ needs.extract-version.outputs.version }}
      prerelease: ${{ needs.extract-version.outputs.prerelease == 'true' }}
    secrets: inherit
